apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-nginx-config
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "nginx.labels.app" . }}
    component: nginx
    name: {{ .Release.Name }}
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }
    http {
      # MIME types
      types {
        text/html                             html htm shtml;
        text/css                              css;
        text/xml                              xml;
        image/gif                             gif;
        image/jpeg                            jpeg jpg;
        application/javascript                js;
        application/atom+xml                  atom;
        application/rss+xml                   rss;
        text/plain                            txt;
        text/x-component                      htc;
        image/png                             png;
        image/svg+xml                         svg svgz;
        image/x-icon                          ico;
        image/webp                            webp;
        application/json                      json;
        application/wasm                      wasm;
        font/woff                             woff;
        font/woff2                            woff2;
      }
      default_type application/octet-stream;

      # Hide Nginx version for security
      server_tokens off;

      # Upstream Service Definitions
      upstream keycloak {
        server {{ .Release.Name }}-keycloak:80;
      }

      upstream java-auth {
        server {{ .Release.Name }}-jauth-svc:80;
      }

      upstream java-tgmt {
        server {{ .Release.Name }}-jtmgmt-svc:80;
      }

      upstream python-tgmt {
        server {{ .Release.Name }}-pytmgmt:80;
      }

      upstream registry-api {
        server {{ .Release.Name }}-agentregistry-svc:80;
      }

      upstream registry-ui {
        server {{ .Release.Name }}-agentregistry-ui-svc:80;
      }

      upstream cams-api {
        server {{ .Release.Name }}-cams-api-svc:80;
      }

      upstream litellm {
        server {{ .Release.Name }}-litellm-svc:80;
      }

      upstream control-tower {
        server {{ .Release.Name }}-controltower-svc:80;
      }

      {{- if or .Values.app.useSelfSignedCert .Values.app.useBringYourOwnCert }}
      # HTTP Server (Redirects to HTTPS)
      server {
        listen 80;
        return 301 https://$host$request_uri;
      }

      # HTTPS Server (SSL Termination)
      server {
        listen 443 ssl;
        
        # Mount paths for the Secret
        ssl_certificate /etc/nginx/ssl/tls.crt;
        ssl_certificate_key /etc/nginx/ssl/tls.key;

        # Basic SSL Settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
      {{- else }}
      # HTTP Server (No SSL)
      server {
        listen 80;
      {{- end }}

        # Keycloak
        location /auth/ {
          proxy_pass http://keycloak/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Port $server_port;
        }

        # Java Auth Management
        location /api/auth/ {
          proxy_pass http://java-auth/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Java Auth Management API
        location /api/v1/auth {
          proxy_pass http://java-auth/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Java Tenant Management
        location /api/tenant/java/ {
          proxy_pass http://java-tgmt/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Python Tenant Management
        location /api/tenant/python/ {
          proxy_pass http://python-tgmt/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Registry API
        location /api/registry/ {
          proxy_pass http://registry-api/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # CAMS API
        location /api/cams/ {
          proxy_pass http://cams-api/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # LiteLLM API
        location /api/litellm/ {
          proxy_pass http://litellm/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Control Tower Assets
        location /control-tower/assets/ {
          proxy_pass http://control-tower/assets/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Control Tower UI
        location /control-tower/ {
          proxy_pass http://control-tower/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Registry UI
        location /registry/ {
          proxy_pass http://registry-ui/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Default location - Registry UI
        location / {
          proxy_pass http://registry-ui/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
      }
    }